# app.py — UAPForge (AI Render only) v1.1 (Streamlit-safe)
import base64
import io
import time
import zipfile
from dataclasses import dataclass
from typing import Optional, Tuple

import requests
import streamlit as st
from PIL import Image

APP_TITLE = "UAPForge — AI Render (CapCut Ready)"

# Model -> allowed sizes per OpenAI docs
GPT_IMAGE_SIZES = ["1024x1536", "1536x1024", "1024x1024", "auto"]          # GPT Image models
DALLE3_SIZES    = ["1024x1024", "1792x1024", "1024x1792"]                  # DALL·E 3

DEFAULT_WEBP_QUALITY = 82
MAX_KEYWORDS = 25

CAPCUT_PRESETS = {
    "Vertical 9:16 (1080×1920) — Shorts/Reels": (1080, 1920),
    "Landscape 16:9 (1920×1080) — YouTube/Doc": (1920, 1080),
    "4K Landscape 16:9 (3840×2160) — Ultra": (3840, 2160),
}

# ---------- helpers ----------
def slugify(s: str) -> str:
    out = "".join(c if c.isalnum() else "-" for c in (s or "").strip().lower()).strip("-")
    return out or "image"

def center_crop_and_resize(img: Image.Image, target_w: int, target_h: int) -> Image.Image:
    img = img.convert("RGB")
    src_w, src_h = img.size
    scale = max(target_w / src_w, target_h / src_h)
    new_size = (int(src_w * scale), int(src_h * scale))
    img = img.resize(new_size, Image.LANCZOS)

    left = (img.width - target_w) // 2
    top = (img.height - target_h) // 2
    return img.crop((left, top, left + target_w, top + target_h))

def to_webp_bytes(img: Image.Image, quality: int = DEFAULT_WEBP_QUALITY) -> bytes:
    buf = io.BytesIO()
    img.save(buf, format="WEBP", quality=int(quality), method=6)
    return buf.getvalue()

def allowed_sizes_for_model(model: str):
    # NOTE: DALL·E 3 is deprecated and scheduled to stop being supported on 05/12/2026
    # but still works today if your account has access.
    if model.strip().lower() == "dall-e-3":
        return DALLE3_SIZES
    return GPT_IMAGE_SIZES

def pick_base_size(model: str, target_w: int, target_h: int) -> str:
    sizes = allowed_sizes_for_model(model)

    # Prefer portrait base for vertical presets, landscape base for horizontal
    if target_h > target_w:
        # GPT: 1024x1536, DALL·E 3: 1024x1792
        return "1
